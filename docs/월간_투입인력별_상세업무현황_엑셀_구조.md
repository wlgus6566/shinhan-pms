# 월간 투입인력별 상세업무현황 엑셀 구조 설명

## 📋 개요
이 문서는 일일업무일지 데이터를 집계하여 생성하는 "월간 투입인력별 상세업무현황" 엑셀 파일의 구조를 설명합니다.

## 📊 파일 기본 정보
- **파일명 형식**: `{월}월_투입인력별상세업무현황.xlsx`
- **시트명**: Sheet1
- **총 열 수**: 14개 (A~N)
- **인코딩**: UTF-8
- **라이브러리**: ExcelJS 권장

---

## 🏗️ 엑셀 구조

### 1. 헤더 영역 (1~4행)

#### 1행: 빈 행
- 전체 빈 행

#### 2행: 제목
- **A2~N2 (병합)**: "투입인력별 상세 업무현황"
- 폰트: Arial, 14pt, Bold
- 정렬: 좌측 정렬

#### 3행: 정상근무 시간 표시
- **M3**: "정상근무 160시간"
- 폰트: Arial, 11pt, Bold

#### 4행: 컬럼 헤더
| 열 | 컬럼명 | 설명 |
|---|---|---|
| A | 담당업무 | 부서/업무 영역 (예: 총괄, 기획, 디자인) |
| B | 역할 | 직책 (PM, PL, PA) |
| C | 이름 | 직원 이름 |
| D | 등급 | 직급 (특급, 고급, 중급, 초급) |
| E | 진행 업무 | 업무명 |
| F | 난이도 | 업무 난이도 (상, 중, 하, -) |
| G | 비고(작업상세 이력) | 업무 상세 설명 |
| H | 1주차 | 해당 월 1주차 투입시간 |
| I | 2주차 | 해당 월 2주차 투입시간 |
| J | 3주차 | 해당 월 3주차 투입시간 |
| K | 4주차 | 해당 월 4주차 투입시간 |
| L | 업무별 투입시간 | 해당 업무의 총 투입시간 |
| M | {월}월 공수(m/h) | 해당 직원의 월간 총 투입시간 |
| N | 일평균 근무시간 | 월간 총 시간 ÷ 20일 |

---

## 📝 데이터 행 구조 (5행부터)

### 직원 그룹 단위 구조

각 직원은 여러 개의 업무를 수행할 수 있으며, 다음과 같은 구조로 표현됩니다:

```
┌─────────────────────────────────────────────────────────────┐
│ [직원 정보 행 - 첫 번째 업무]                                     │
│ A: 담당업무 | B: 역할 | C: 이름 | D: 등급 | E~K: 첫 번째 업무 데이터  │
│ L: 첫 번째 업무 투입시간 | M: 월간 총 공수 | N: 일평균 근무시간         │
├─────────────────────────────────────────────────────────────┤
│ [추가 업무 행들]                                                 │
│ A~D: 빈 칸 | E~K: 두 번째 업무 데이터 | L: 두 번째 업무 투입시간      │
│ A~D: 빈 칸 | E~K: 세 번째 업무 데이터 | L: 세 번째 업무 투입시간      │
│ ...                                                          │
└─────────────────────────────────────────────────────────────┘
```

### 셀 병합 규칙

한 직원이 여러 업무를 수행하는 경우, 다음 열들이 **세로 병합**됩니다:
- **A열 (담당업무)**: 같은 직원의 모든 업무 행에 걸쳐 병합
- **B열 (역할)**: 같은 직원의 모든 업무 행에 걸쳐 병합
- **C열 (이름)**: 같은 직원의 모든 업무 행에 걸쳐 병합
- **D열 (등급)**: 같은 직원의 모든 업무 행에 걸쳐 병합
- **M열 (월 공수)**: 같은 직원의 모든 업무 행에 걸쳐 병합
- **N열 (일평균)**: 같은 직원의 모든 업무 행에 걸쳐 병합

### 예시 데이터

#### 예시 1: 단일 업무 직원 (김진아)
```
행5: 총괄 | PM | 김진아 | 특급 | 프로젝트 전체 관리 | 상 | 오류 수정 대응 | 32 | 40 | 40 | 48 | 160 | 160 | 8
```
→ 병합 없음 (1개 업무만 수행)

#### 예시 2: 다중 업무 직원 (박지황 - 8개 업무)
```
행7:  기획 | PA | 박지황 | 고급 | [마이카] 주말대출 B2B 플랫폼 구축 | 상 | 인수인계 완료 | 0 | 0 | 0 | 0 | 0 | 160 | 8
행8:  (병합)|(병합)|(병합)|(병합)| 마이샵_쿠폰/상품권 화면 수정 2건 | 하 | 오류 수정 대응 | 3 | 10 | 0 | 2 | 15 | (병합) | (병합)
행9:  (병합)|(병합)|(병합)|(병합)| 이용대금 명세서 PDF... | 하 | 기획서 업데이트 | 15 | 0 | 10 | 4 | 29 | (병합) | (병합)
...
행14: (병합)|(병합)|(병합)|(병합)| 휴가 | - | 연차 | 0 | 8 | 0 | 8 | 16 | (병합) | (병합)
```
→ A7:A14, B7:B14, C7:C14, D7:D14, M7:M14, N7:N14 병합

---

## 🔢 수식 (Formulas)

### L열 (업무별 투입시간)
각 업무의 주차별 시간 합계
```
=SUM(H{row}:K{row})
```
예시:
- L5: `=SUM(H5:K5)` → 1주차~4주차 합계

### M열 (월 공수)

#### 단일 업무 직원
```
=L{row}
```
예시:
- M5: `=L5` (김진아 - 1개 업무만 수행)

#### 다중 업무 직원
첫 번째 업무 행에 전체 업무의 합계 수식
```
=SUM(L{start_row}:L{end_row})
```
예시:
- M7: `=SUM(L7:L14)` (박지황 - 7~14행까지 8개 업무)
- M15: `=SUM(L15:L21)` (이남규 - 15~21행까지 7개 업무)

특별한 경우:
```
=0+SUM(L{start_row}:L{end_row})
```
예시:
- M6: `=0+SUM(L6:L6)` (단일 업무이지만 0을 더함)

### N열 (일평균 근무시간)
월간 공수를 20일(표준 근무일)로 나눈 값
```
=M{row}/20
```
예시:
- N5: `=M5/20` → 160/20 = 8
- N7: `=M7/20` → 160/20 = 8

---

## 🎨 스타일 가이드

### 폰트
- **헤더**: Arial, 11pt, Bold
- **일반 셀**: Arial, 10pt

### 정렬
- **헤더 행**: 중앙 정렬 (수직, 수평)
- **데이터 셀**: 중앙 정렬 (수직, 수평)
- **G열 (비고)**: 좌측 정렬 (수직 중앙, 수평 좌측)

### 테두리
- **모든 데이터 셀**: 얇은 테두리 (thin border)
```javascript
border: {
  top: { style: 'thin' },
  left: { style: 'thin' },
  bottom: { style: 'thin' },
  right: { style: 'thin' }
}
```

### 열 너비
| 열 | 너비 | 용도 |
|---|---|---|
| A | 12 | 담당업무 |
| B | 8 | 역할 |
| C | 10 | 이름 |
| D | 8 | 등급 |
| E | 35 | 진행 업무 |
| F | 8 | 난이도 |
| G | 40 | 비고 |
| H | 8 | 1주차 |
| I | 8 | 2주차 |
| J | 8 | 3주차 |
| K | 8 | 4주차 |
| L | 12 | 업무별 투입시간 |
| M | 15 | 월 공수 |
| N | 12 | 일평균 근무시간 |

---

## 📅 주차 계산 로직

일일업무일지의 날짜를 주차로 변환하는 방법:

```javascript
function getWeekOfMonth(dateString) {
  const date = new Date(dateString);
  const day = date.getDate();
  
  if (day <= 7) return 1;      // 1~7일: 1주차
  if (day <= 14) return 2;     // 8~14일: 2주차
  if (day <= 21) return 3;     // 15~21일: 3주차
  return 4;                    // 22일~: 4주차
}
```

---

## 🔄 데이터 변환 프로세스

### 입력: 일일업무일지 데이터
```json
{
  "date": "2026-01-26",
  "employeeName": "김진아",
  "role": "PM",
  "grade": "특급",
  "department": "총괄",
  "task": "프로젝트 전체 관리",
  "taskDetail": "오류 수정 대응",
  "hours": 8,
  "difficulty": "상"
}
```

### 변환 단계

#### 1단계: 직원별로 그룹화
```javascript
const employeeMap = new Map();
// key: 직원 이름
// value: { 기본정보, 업무목록[] }
```

#### 2단계: 업무별 주차별 시간 집계
```javascript
{
  name: "김진아",
  role: "PM",
  grade: "특급",
  department: "총괄",
  tasks: [
    {
      taskName: "프로젝트 전체 관리",
      difficulty: "상",
      detail: "오류 수정 대응",
      weeklyHours: {
        week1: 32,  // 1주차 총 시간
        week2: 40,  // 2주차 총 시간
        week3: 40,  // 3주차 총 시간
        week4: 48   // 4주차 총 시간
      },
      totalHours: 160
    }
  ],
  totalMonthlyHours: 160,
  avgDailyHours: 8
}
```

#### 3단계: 엑셀 생성
- 직원별로 행 그룹 생성
- 수식 적용
- 셀 병합
- 스타일 적용

---

## 💡 특이사항 및 주의점

### 1. 휴가 처리
- **업무명**: "휴가"
- **난이도**: "-" (하이픈)
- **비고**: "연차"
- 휴가도 근무시간에 포함됨 (예: 8시간)

### 2. 숫자 형식
- **시간**: 정수 (8, 40, 160 등)
- **일평균**: 소수점 2자리 (8.00, 8.05 등)

### 3. 빈 셀 처리
- 병합된 영역의 하위 셀들은 빈 값
- E~L열에서 데이터가 없는 경우 빈 문자열

### 4. 월간 공수 계산
```javascript
// 각 직원의 모든 업무 시간 합계
totalMonthlyHours = sum(모든 업무의 totalHours)
```

### 5. 일평균 근무시간 계산
```javascript
// 월간 총 시간 ÷ 20일 (표준 근무일수)
avgDailyHours = totalMonthlyHours / 20
```

### 6. 실제 근무일수 기준 계산 (선택사항)
공휴일과 주말을 제외한 실제 근무일수로 계산하려면:
```javascript
function getWorkingDaysInMonth(year, month) {
  const daysInMonth = new Date(year, month, 0).getDate();
  let workingDays = 0;

  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month - 1, day);
    const dayOfWeek = date.getDay();
    // 주말(토요일=6, 일요일=0) 제외
    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
      workingDays++;
    }
  }

  return workingDays;
}

// 일평균 = 월간 총 시간 ÷ 실제 근무일수
avgDailyHours = totalMonthlyHours / getWorkingDaysInMonth(year, month)
```

---

## 📦 ExcelJS 구현 예시

### 기본 구조 생성
```javascript
import ExcelJS from 'exceljs';

const workbook = new ExcelJS.Workbook();
const worksheet = workbook.addWorksheet('Sheet1');

// 열 너비 설정
worksheet.columns = [
  { width: 12 },  // A: 담당업무
  { width: 8 },   // B: 역할
  { width: 10 },  // C: 이름
  { width: 8 },   // D: 등급
  { width: 35 },  // E: 진행 업무
  { width: 8 },   // F: 난이도
  { width: 40 },  // G: 비고
  { width: 8 },   // H: 1주차
  { width: 8 },   // I: 2주차
  { width: 8 },   // J: 3주차
  { width: 8 },   // K: 4주차
  { width: 12 },  // L: 업무별 투입시간
  { width: 15 },  // M: 월 공수
  { width: 12 }   // N: 일평균
];
```

### 헤더 생성
```javascript
let row = 1;

// 빈 행
row++;

// 제목
worksheet.mergeCells(row, 1, row, 14);
worksheet.getCell(row, 1).value = '투입인력별 상세 업무현황';
worksheet.getCell(row, 1).font = { name: 'Arial', size: 14, bold: true };
row++;

// 정상근무 시간
worksheet.getCell(row, 13).value = '정상근무 160시간';
worksheet.getCell(row, 13).font = { name: 'Arial', size: 11, bold: true };
row++;

// 컬럼 헤더
const headers = [
  '담당업무', '역할', '이름', '등급', '진행 업무', '난이도',
  '비고(작업상세 이력)', '1주차', '2주차', '3주차', '4주차',
  '업무별 투입시간', '11월 공수\n(m/h)', '일평균 근무시간'
];

headers.forEach((header, index) => {
  const cell = worksheet.getCell(row, index + 1);
  cell.value = header;
  cell.font = { name: 'Arial', size: 11, bold: true };
  cell.alignment = { vertical: 'middle', horizontal: 'center' };
  cell.border = {
    top: { style: 'thin' },
    left: { style: 'thin' },
    bottom: { style: 'thin' },
    right: { style: 'thin' }
  };
});
row++;
```

### 데이터 행 생성
```javascript
employees.forEach(employee => {
  const startRow = row;

  // 첫 번째 업무 (직원 정보 포함)
  const firstTask = employee.tasks[0];
  worksheet.getCell(row, 1).value = employee.department;
  worksheet.getCell(row, 2).value = employee.role;
  worksheet.getCell(row, 3).value = employee.name;
  worksheet.getCell(row, 4).value = employee.grade;
  worksheet.getCell(row, 5).value = firstTask.taskName;
  worksheet.getCell(row, 6).value = firstTask.difficulty;
  worksheet.getCell(row, 7).value = firstTask.detail;
  worksheet.getCell(row, 8).value = firstTask.weeklyHours.week1;
  worksheet.getCell(row, 9).value = firstTask.weeklyHours.week2;
  worksheet.getCell(row, 10).value = firstTask.weeklyHours.week3;
  worksheet.getCell(row, 11).value = firstTask.weeklyHours.week4;
  worksheet.getCell(row, 12).value = { formula: `=SUM(H${row}:K${row})` };
  
  // 월 공수 수식
  if (employee.tasks.length === 1) {
    worksheet.getCell(row, 13).value = { formula: `=L${row}` };
  } else {
    worksheet.getCell(row, 13).value = { 
      formula: `=SUM(L${startRow}:L${startRow + employee.tasks.length - 1})` 
    };
  }
  
  worksheet.getCell(row, 14).value = { formula: `=M${row}/20` };
  row++;

  // 추가 업무들
  for (let i = 1; i < employee.tasks.length; i++) {
    const task = employee.tasks[i];
    worksheet.getCell(row, 5).value = task.taskName;
    worksheet.getCell(row, 6).value = task.difficulty;
    worksheet.getCell(row, 7).value = task.detail;
    worksheet.getCell(row, 8).value = task.weeklyHours.week1;
    worksheet.getCell(row, 9).value = task.weeklyHours.week2;
    worksheet.getCell(row, 10).value = task.weeklyHours.week3;
    worksheet.getCell(row, 11).value = task.weeklyHours.week4;
    worksheet.getCell(row, 12).value = { formula: `=SUM(H${row}:K${row})` };
    row++;
  }

  // 셀 병합 (직원이 여러 업무를 수행한 경우)
  if (employee.tasks.length > 1) {
    worksheet.mergeCells(startRow, 1, row - 1, 1);  // 담당업무
    worksheet.mergeCells(startRow, 2, row - 1, 2);  // 역할
    worksheet.mergeCells(startRow, 3, row - 1, 3);  // 이름
    worksheet.mergeCells(startRow, 4, row - 1, 4);  // 등급
    worksheet.mergeCells(startRow, 13, row - 1, 13); // 월 공수
    worksheet.mergeCells(startRow, 14, row - 1, 14); // 일평균
  }

  // 스타일 적용
  for (let r = startRow; r < row; r++) {
    for (let c = 1; c <= 14; c++) {
      const cell = worksheet.getCell(r, c);
      cell.font = { name: 'Arial', size: 10 };
      cell.alignment = { 
        vertical: 'middle', 
        horizontal: c === 7 ? 'left' : 'center' // G열만 좌측 정렬
      };
      cell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
      };
    }
  }
});
```

### 파일 저장
```javascript
const buffer = await workbook.xlsx.writeBuffer();
// Buffer를 파일로 저장하거나 HTTP 응답으로 전송
```

---

## 🚀 API 연동 예시

### 엔드포인트
```
POST /api/reports/generate-monthly
```

### 요청 본문
```json
{
  "year": 2026,
  "month": 11,
  "dailyWorks": [
    {
      "date": "2026-11-01",
      "employeeName": "김진아",
      "role": "PM",
      "grade": "특급",
      "department": "총괄",
      "task": "프로젝트 전체 관리",
      "taskDetail": "오류 수정 대응",
      "hours": 8,
      "difficulty": "상"
    }
  ]
}
```

### 응답
```
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="11월_투입인력별상세업무현황.xlsx"

[Excel Binary Data]
```

---

## 📋 체크리스트

개발 시 확인해야 할 사항:

- [ ] 열 너비가 명세대로 설정되었는가?
- [ ] 제목 행이 병합되었는가?
- [ ] 컬럼 헤더에 테두리와 볼드체가 적용되었는가?
- [ ] 주차 계산 로직이 정확한가? (1-7일: 1주차, 8-14일: 2주차...)
- [ ] L열 수식이 올바른가? (`=SUM(H:K)`)
- [ ] M열 수식이 업무 개수에 따라 올바른가?
- [ ] N열 수식이 올바른가? (`=M/20`)
- [ ] 다중 업무 직원의 셀 병합이 정확한가? (A, B, C, D, M, N)
- [ ] G열(비고)이 좌측 정렬되었는가?
- [ ] 나머지 열들은 중앙 정렬되었는가?
- [ ] 모든 데이터 셀에 테두리가 적용되었는가?
- [ ] 폰트가 Arial로 설정되었는가?
- [ ] 휴가가 별도 업무로 집계되었는가?
- [ ] 파일명이 `{월}월_투입인력별상세업무현황.xlsx` 형식인가?

---

## 📚 참고 자료

### ExcelJS 공식 문서
- https://github.com/exceljs/exceljs

### 주요 메서드
- `worksheet.mergeCells()`: 셀 병합
- `worksheet.getCell()`: 셀 접근
- `cell.value = { formula: '...' }`: 수식 설정
- `workbook.xlsx.writeBuffer()`: Buffer 생성

---

이 문서는 월간 투입인력별 상세업무현황 엑셀 파일의 구조를 완전히 설명하며, NestJS 프로젝트에서 ExcelJS 라이브러리를 사용하여 구현할 수 있습니다.
